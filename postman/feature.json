{
	"info": {
		"_postman_id": "93dfb739-453b-4401-95e6-c1e27b68aa2d",
		"name": "Comments Feature",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "47066772"
	},
	"item": [
		{
			"name": "Setup",
			"item": [
				{
					"name": "Create User",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"User created\", function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"pm.environment.set(\"userId\", pm.response.json().id);"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"{{$timestamp}}@mail.com\",\n  \"name\": \"User {{$timestamp}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/admin/users",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"admin",
								"users"
							]
						}
					},
					"response": []
				},
				{
					"name": "Create Category",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Category created\", function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"pm.environment.set(\"categoryId\", pm.response.json().id);"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"name\": \"Category {{$timestamp}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/admin/categories",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"admin",
								"categories"
							]
						}
					},
					"response": []
				},
				{
					"name": "Create Event",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Event created\", function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"pm.environment.set(\"eventId\", pm.response.json().id);"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"annotation\": \"Best concert ever in test Event\",\n  \"category\": {{categoryId}},\n  \"description\": \"Full description in event\",\n  \"eventDate\": \"2030-01-01 12:00:00\",\n  \"location\": { \"lat\": 55.75, \"lon\": 37.61 },\n  \"paid\": false,\n  \"participantLimit\": 10,\n  \"requestModeration\": true,\n  \"title\": \"Rock Concert\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/users/{{userId}}/events",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"users",
								"{{userId}}",
								"events"
							]
						}
					},
					"response": []
				},
				{
					"name": "Publish Event",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Event published\", function () {",
									"    pm.response.to.have.status(200);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PATCH",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{ \"stateAction\": \"PUBLISH_EVENT\" }"
						},
						"url": {
							"raw": "{{baseUrl}}/admin/events/{{eventId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"admin",
								"events",
								"{{eventId}}"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Create Comment (PENDING)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status is 201\", function () { pm.response.to.have.status(201); });",
							"const json = pm.response.json();",
							"pm.test(\"Comment has PENDING status\", function () { pm.expect(json.status).to.eql(\"PENDING\"); });",
							"pm.environment.set(\"commentId\", json.id);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{ \"text\": \"Очень классное событие!\" }"
				},
				"url": {
					"raw": "{{baseUrl}}/users/{{userId}}/events/{{eventId}}/comments",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"users",
						"{{userId}}",
						"events",
						"{{eventId}}",
						"comments"
					]
				}
			},
			"response": []
		},
		{
			"name": "Admin Get PENDING Comments",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"let json;",
							"json = pm.response.json();",
							"",
							"pm.test(\"Response is valid JSON\");",
							"",
							"",
							"pm.test(\"Pending comment is visible for admin\", function () {",
							"    pm.expect(Array.isArray(json)).to.be.true;",
							"    const ids = json.map(c => c.id);",
							"    pm.expect(ids).to.include(Number(pm.environment.get(\"commentId\")));",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/admin/comments?status=PENDING",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"admin",
						"comments"
					],
					"query": [
						{
							"key": "status",
							"value": "PENDING"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Admin Publish Comment",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status is 200\", function () { pm.response.to.have.status(200); });",
							"const json = pm.response.json();",
							"pm.test(\"Comment is published\", function () { pm.expect(json.status).to.eql(\"PUBLISHED\"); });"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{baseUrl}}/admin/comments/{{commentId}}?status=PUBLISHED",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"admin",
						"comments",
						"{{commentId}}"
					],
					"query": [
						{
							"key": "status",
							"value": "PUBLISHED"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Published Comments",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"const json = pm.response.json();",
							"",
							"pm.test(\"Published comment is visible\", function () {",
							"    pm.expect(Array.isArray(json)).to.be.true;",
							"    pm.expect(json.length).to.eql(1);",
							"    pm.expect(json[0].id).to.eql(Number(pm.environment.get(\"commentId\")));",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}/events/{{eventId}}/comments",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"events",
						"{{eventId}}",
						"comments"
					]
				}
			},
			"response": []
		}
	]
}